<!DOCTYPE html>
<html lang="en" data-bs-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>會員中心</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3">

  <link rel="stylesheet" href="../css/bootstrap.min.css">
  <link rel="stylesheet" href="../css/headers.css">
  <link rel="stylesheet" href="../css/sidebars.css">

  <!-- jQuery -->
  <script src="../jquery/jquery-3.7.1.min.js"></script>

  <style>
    aside {
      /* position: fixed; */
      float: left;
      width: 20%;
      /* height: 100vh; */
      /* border: 1px solid red; */
    }

    main {
      /* border: 1px solid blue; */
      /* overflow-y: auto; */
    }

    .container {
      max-width: 960px;
    }

    /* S Start */
    div.newsadd {
      width: 85.3%;
      margin: 20px auto;
    }

    div.newsaddcontainer {
      width: 85.3%;
      margin: 20px auto;
    }

    div.newsaddbt button {
      align-items: flex-end;
    }

    img.avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px dotted black;
    }

    /* S end */
  </style>
</head>

<body>
  <!-- 導入共用 header -->
  <div class="headerPage"></div>

  <!-- 開發畫面 -->
  <div class="asidePage"></div>
  <main>
    <aside>
      <div class="flex-shrink-0 p-3">
        <ul class="list-unstyled ps-0">
          <li class="mb-1">
            <button class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed"
              data-bs-toggle="collapse" data-bs-target="#user-collapse" aria-expanded="false">
              會員基本資料
            </button>
            <div class="collapse" id="user-collapse">
              <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
                <li><a href="../user/user_info.html"
                    class="link-body-emphasis d-inline-flex text-decoration-none rounded">基本資料</a>
                </li>
              </ul>
            </div>
            <div class="collapse" id="user-collapse">
              <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
                <li><a href="../user/user_psw.html"
                    class="link-body-emphasis d-inline-flex text-decoration-none rounded">修改密碼</a>
                </li>
              </ul>
            </div>
          </li>
          <li class="mb-1">
            <button class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed"
              data-bs-toggle="collapse" data-bs-target="#article-collapse" aria-expanded="false">
              我的文章/新聞列表
            </button>
            <div class="collapse" id="article-collapse">
              <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
                <li><a href="/newsf/news_fmgr.html"
                    class="link-body-emphasis d-inline-flex text-decoration-none rounded">文章管理功能</a>
                </li>
              </ul>
            </div>
          </li>
          <li class="mb-1">
            <button class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed"
              data-bs-toggle="collapse" data-bs-target="#collection-collapse" aria-expanded="false">
              我的收藏
            </button>
            <div class="collapse" id="collection-collapse">
              <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
                <li><a href="../user/collection/c_article.html"
                    class="link-body-emphasis d-inline-flex text-decoration-none rounded">收藏文章管理</a>
                </li>
                <li><a href="../user/collection/c_news.html"
                    class="link-body-emphasis d-inline-flex text-decoration-none rounded">收藏新聞管理</a>
                </li>
                <li><a href="../user/collection/c_commodity.html"
                    class="link-body-emphasis d-inline-flex text-decoration-none rounded">收藏商品管理</a>
                </li>
              </ul>
            </div>
          </li>
          <li class="mb-1">
            <button class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed"
              data-bs-toggle="collapse" data-bs-target="#team-collapse" aria-expanded="false">
              關注球隊
            </button>
            <div class="collapse" id="team-collapse">
              <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
                <li><a href="../user/team/t_recent_game.html"
                    class="link-body-emphasis d-inline-flex text-decoration-none rounded">近期賽事</a>
                </li>
                <li><a href="../user/team/t_historical_inf.html"
                    class="link-body-emphasis d-inline-flex text-decoration-none rounded">歷史資料</a>
                </li>
                <li><a href="../user/team/t_player.html"
                    class="link-body-emphasis d-inline-flex text-decoration-none rounded">關注的球員</a>
                </li>
                <li><a href="../user/team/t_cheer.html"
                    class="link-body-emphasis d-inline-flex text-decoration-none rounded">關注的啦啦隊</a>
                </li>
              </ul>
            </div>
          </li>
          <li class="mb-1">
            <button class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed"
              data-bs-toggle="collapse" data-bs-target="#car-collapse" aria-expanded="false">
              我的購物車
            </button>
            <div class="collapse" id="car-collapse">
              <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
                <li><a href="../estore/cart.html"
                    class="link-body-emphasis d-inline-flex text-decoration-none rounded">我的購物車</a>
                </li>
              </ul>
            </div>
          </li>
        </ul>
      </div>
    </aside>


    <div class="container">
      <div class="row g-5 p-3">
        <div class="col-md-7 col-lg-11">
          <div id="editMode" class="">
            <h4 class="mb-3">個人資料</h4>
            <form class="needs-validation" novalidate>
              <div class="row g-3">
                <div class="col-12">
                  <label for="image" class="form-label"></label>
                  <input type="file" class="form-control" id="image">
                  <img src="../img/default-150x150.png" id="userAvatar" class="avatar" src="" alt="avatar" style="width: 100px; height: 100px;">
                  <div class="invalid-feedback">
                    Valid first name is required.
                  </div>
                </div>
              </div>
              <div class="row g-3">
                <div class="col-12">
                  <label for="name" class="form-label">姓名</label>
                  <input type="text" class="form-control" id="name" placeholder="" value="" required>
                  <div class="invalid-feedback">
                    Valid first name is required.
                  </div>
                </div>
                <div class="col-12">
                  <label for="userid" class="form-label">會員編號(僅顯示無法更改)</label>
                  <div class="input-group has-validation">
                    <input type="text" class="form-control" id="userid" placeholder="" disabled required readonly>
                    <div class="invalid-feedback">
                      Your userid is required.
                    </div>
                  </div>
                </div>
                <div class="col-12">
                  <label for="accout" class="form-label">會員帳號(僅顯示無法更改)</label>
                  <div class="input-group has-validation">
                    <input type="text" class="form-control" id="accout" placeholder="" disabled required readonly>
                    <div class="invalid-feedback">
                      Your accout is required.
                    </div>
                  </div>
                </div>
                <div class="col-12">
                  <label for="email" class="form-label">Email</label>
                  <input type="email" class="form-control" id="email" placeholder="you@example.com" required>
                  <div class="invalid-feedback">
                    Please enter a valid email address.
                  </div>
                </div>
                <div class="col-12">
                  <label for="phone" class="form-label">連絡電話</label>
                  <input type="text" class="form-control" id="phone" placeholder="0987654321" required>
                  <div class="invalid-feedback">
                    Please enter your phone number.
                  </div>
                </div>
                <div class="d-flex justify-content-end">
                  <button type="button" id="cancelBtn" class="btn btn-secondary me-2">取消</button>
                  <button type="button" id="saveBtn" class="btn btn-primary">儲存</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>


  <!-- 導入共用 footer -->
  <div class="footerPage"></div>

  <script>
    $(".headerPage").load("../layout/header.html");
    $(".footerPage").load("../layout/footer.html");
    // $(".asidePage").load("./aside.html");
  </script>
  <script src="../js/bootstrap.bundle.min.js"></script>
  <script src="https://kit.fontawesome.com/799bf36dfe.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>

    $(document).ready(function () {
      const userData = sessionStorage.getItem("user");
      const user = JSON.parse(userData);

      console.log(user);

      // 插入使用者資料
      $("#userid").val(user.userId);
      $("#userAvatar").val(user.avatar);
      $("#name").val(user.name);
      $("#accout").val(user.account);
      $("#email").val(user.email);
      $("#phone").val(user.phone);

      document.getElementById('image').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = function () {
            // 取得base64格式的圖片
            const base64Image = reader.result;

            // 顯示在img區塊
            document.getElementById('userAvatar').src = base64Image;
          };
          reader.readAsDataURL(file);
        }
      });


      // 儲存資料
      $('#saveBtn').on("click", function (e) {
        var form = document.querySelector('.needs-validation');

        // 檢查表單是否通過驗證
        if (!form.checkValidity()) {
          e.preventDefault();
          e.stopPropagation();
          form.classList.add('was-validated');
          return; // 若驗證失敗，不執行儲存與切換動作
        }
        // 獲取輸入框中的值
        const name = $('#name').val();
        const email = $('#email').val();
        const phone = $('#phone').val();

        const requestData = {
          userId: user.userId,
          name: name,
          email: email,
          phone: phone
        };

        // console.log('更新資料: ', requestData);

        fetch('/NGFW/user/user_edit', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        })
          .then(response => response.json())
          .then(data => {
            if (data.successfully) {
              Swal.fire({
                icon: "success",
                title: "更新成功!",
                text: "",
              });
              // 更新 sessionStorage 中的資料
              const updatedUser = JSON.parse(sessionStorage.getItem("user"));

              updatedUser = {
                userId: user.userId,
                account: data.account,
                // avatar: data.avatar,
                name: data.name,
                email: data.email,
                phone: data.phone,
                status: user.status,
                roleId: user.roleId,
                role: user.role,
                successfully: user.successfully
              }
              sessionStorage.setItem("user", JSON.stringify(updatedUser));

              window.location.href = './user/user_info.html';
            } else {
              alert('更新失敗:', data.message);
            }
          })
          .catch(error => {
            alert('發生錯誤:', data.message);
          });
      });

      // 啟用 Bootstrap 表單驗證
      (function () {
        'use strict'

        var forms = document.querySelectorAll('.needs-validation');

        Array.prototype.slice.call(forms).forEach(function (form) {
          form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
            }

            form.classList.add('was-validated');
          }, false);
        });
      })();

      // 取消按鈕
      $('#cancelBtn').on("click", function () {
        window.location.href = '../user/user_info.html';
      });
    });
  </script>
</body>