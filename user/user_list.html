<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>上班不要看球賽管理系統</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel='stylesheet'
    href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback'>
  <!-- Font Awesome -->
  <link rel='stylesheet' href='../vendors/fontawesome-free/css/all.min.css'>
  <!-- overlayScrollbars -->
  <link rel='stylesheet' href='../css/adminlte/OverlayScrollbars.min.css'>
  <!-- Theme style -->
  <link rel='stylesheet' href='../css/adminlte/adminlte.min.css'>
  <!-- Bootstrap 5 -->
  <link rel='stylesheet' href='../css/bootstrap.min.css'>

  <style>
    input[disabled] {
      background: #efefef !important;
      cursor: not-allowed;
    }

    div.left_block {
      /* border: 1px solid green; */
      flex-basis: 150px;
      flex-shrink: 0;
    }

    div.right_block {
      /* border: 1px solid red; */
      flex-grow: 1;
    }

    #preview {
      border: 1px dashed black;
      display: inline-block;
      width: 100%;
      height: 120px;
      position: relative;
      cursor: pointer;
      text-align: center;
    }

    #preview span.text {
      position: absolute;
      display: inline-block;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: -1;
      color: white;
    }

    #preview img.preview_img {
      max-width: 100%;
      max-height: 100%;
      position: relative;
      z-index: -1;
    }

    #preview.-on {
      box-shadow: 5px 5px 15px white inset, -5px -5px 15px white inset;
    }
  </style>
</head>

<body class='hold-transition sidebar-mini'>

  <!-- Site wrapper -->
  <div class='wrapper'>

    <!-- 導入共用 Navbar -->
    <div class='Navbar'></div>
    <!-- 導入共用 Sidebar -->
    <div class='Sidebar'></div>

    <!-- 開發畫面區塊start -->
    <section class='content-wrapper'>

      <!-- content-header，包括頁面名稱、麵包屑 -->
      <section class='content-header'>
        <div>
          <nav aria-label='breadcrumb'>
        </div>
        <ol class='breadcrumb breadcrumb-chevron p-3 bg-body-tertiary rounded-3'>
          <li class='breadcrumb-item'>
            <a class='link-body-emphasis fw-semibold text-decoration-none fs-3' href='#'>使用者資料管理</a>
          </li>
          <li class='breadcrumb-item active fs-3' aria-current='page'>
            使用者角色管理
          </li>
        </ol>
        </nav>
      </section>
      <!-- content-header end -->

      <!-- content，實際頁面內容 -->
      <section class='content'>
        <div class='card'>
          <!-- card-header -->
          <!-- <div class='card-header'>
            <div class='input-group'>
              <div class='input-group-prepend'>
                <button type='button' class='btn btn-default dropdown-toggle keyword_dropdwn_btn'
                  data-toggle='dropdown'>
                  關鍵字
                </button>
                <div class='dropdown-menu'>
                  <a class='dropdown-item user_id' href='#'>使用者編號</a>
                  <a class='dropdown-item user_name' href='#'>使用者姓名</a>
                  <a class='dropdown-item user_phone' href='#'>使用者電話</a>
                  <div class='dropdown-divider'></div>
                  <a class='dropdown-item' href='#'>Separated link</a>
                </div>
              </div>
              /btn-group
              <div class='p-3'>
                <input type='text' class='form-control form-control-lg fa-align-center'>
              </div>
              Split button
              <div class='p-3'>
                <div class='btn-group'>
                  <button type='button' class='btn btn-success user_role_btn'>使用者角色</button>
                  <button type='button' class='btn btn-success dropdown-toggle user_role_dropdwn_btn'
                    data-toggle='dropdown'>
                    <span class='sr-only'>Toggle Dropdown</span>
                  </button>
                  <div class='dropdown-menu user_role' role='menu'>
                    <a class='dropdown-item normal_user' href='#'>一般使用者</a>
                    <a class='dropdown-item author' href='#'>文章新聞撰寫者</a>
                    <a class='dropdown-item' href='#'>Separated link</a>
                  </div>
                </div>
                <div class='btn-group'>
                  <button type='button' class='btn btn-warning user_status_btn'>狀態</button>
                  <button type='button' class='btn btn-warning dropdown-toggle dropdown-icon user_status_dropdwn_btn'
                    data-toggle='dropdown'>
                    <span class='sr-only'>Toggle Dropdown</span>
                  </button>
                  <div class='dropdown-menu user_status' role='menu'>
                    <a class='dropdown-item inactivated' href='#'>未啟用</a>
                    <a class='dropdown-item activated' href='#'>已啟用</a>
                    <a class='dropdown-item grounding' href='#'>停用</a>
                    <a class='dropdown-item suspended' href='#'>禁用</a>
                    <div class='dropdown-divider'></div>
                    <a class='dropdown-item' href='#'>Separated link</a>
                  </div>
                </div>
              </div>
              <div class='p-3'>
                <div class='btn-group'>
                  <button type='button' class='btn btn-info order_export_btn'>匯出</button>
                  <button type='button' class='btn btn-info dropdown-toggle dropdown-icon order_export_dropdwn_btn'
                    data-toggle='dropdown'>
                    <span class='sr-only'>Toggle Dropdown</span>
                  </button>
                  <div class='dropdown-menu export_type' role='menu'>
                    <a class='dropdown-item for_excel' href='#'>.xml</a>
                    <a class='dropdown-item for_pdf' href='#'>.pdf</a>
                  </div>
                </div>
              </div>
            </div>
          </div> -->
          <!-- /.card-header -->
          <!-- card-body -->
          <div class='card-body'>
            <table id='user_info' class='table table-bordered table-striped user_info'>
              <thead>
                <tr>
                  <th><input type='checkbox' class='check_all'></th>
                  <th class='user_id'>使用者編號</th>
                  <th class='user_name'>使用者姓名</th>
                  <th class='user_status'>狀態</th>
                  <th class='user_role'>使用者角色</th>
                  <th class='user_email'>使用者email</th>
                  <th class='user_phone'>使用者電話</th>
                  <th class='spacing_block'></th>
                </tr>
              </thead>
              <tbody class='user_lists'>
              </tbody>
            </table>
          </div>
          <!-- /.card-body -->
        </div>
      </section>
      <!-- content end -->

    </section>
    <!-- 開發畫面區塊end -->

  </div>
  <!-- wrapper end -->

  <!-- jQuery -->
  <script src='../jquery/adminlte/jquery.min.js'></script>
  <!-- Bootstrap 5 -->
  <script src='../js/bootstrap.bundle.min.js'></script>
  <!-- overlayScrollbars -->
  <script src='../jquery/adminlte/jquery.overlayScrollbars.min.js'></script>
  <!-- AdminLTE App -->
  <script src='../js/adminlte/adminlte.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    $('.Navbar').load('../layout/navbar.html');
    $('.Sidebar').load('../layout/sidebar.html');

    $(function () {
      fetch("/NGFW/user/user_list")
        .then(response => response.json())
        .then(lists => {
          for (let list of lists) {
            if (list.status === 0) {
              list.status = "未啟用";
            } else {
              if (list.status === 1) {
                list.status = "已啟用";
              } else {
                list.status = "停用";
              }
            }

            if (list.role.roleId === 4) {
              list.role.roleType = "文章編輯者";
            } else {
              if (list.role.roleId === 6) {
                list.role.roleType = "一般使用者";
              } else {
                if (list.role.roleId === 13) {
                  list.role.roleType = "未啟用使用者";
                };
              }
            }

            $(".user_lists").append(
              `<tr>
                  <td><input type='checkbox' class='check_el'></td>
                  <td class="userId" data-bs-target=#${list.userId}>${list.userId}</td>
                  <td>${list.name}</td>
                  <td>
                    <button class="btn btn-secondary dropdown-toggle status_dropdown" href="#" role="button" id="dropdownMenuLink" type="button"
                      data-bs-toggle="dropdown" aria-expanded="false">
                      ${list.status}
                    </button>
                    <ul class="dropdown-menu drop_status" data-bs-target=#${list.status} aria-labelledby="dropdownMenuLink">
                      <li><a class="dropdown-item drop_status_el inactivated" value="0">未啟用</a></li>
                      <li><a class="dropdown-item drop_status_el activated" value="1">已啟用</a></li>
                      <li><a class="dropdown-item drop_status_el grounding" value="2">停用</a></li>
                    </ul>
                  </td>
                  <td>
                    <button class="btn btn-secondary dropdown-toggle role_dropdown" href="#" role="button" id="dropdownMenuLink"
                      data-bs-toggle="dropdown" aria-expanded="false">
                      ${list.role.roleType}
                    </button>
                    <ul class="dropdown-menu drop_role" data-bs-target=#${list.roleId} aria-labelledby="dropdownMenuLink">
                      <li><a class="dropdown-item drop_role_el admin" value="4">文章編輯者</a></li>
                      <li><a class="dropdown-item drop_role_el cs" value="6">一般使用者</a></li>
                      <li><a class="dropdown-item drop_role_el store" value="13">未啟用使用者</a></li>
                    </ul>
                  </td>
                  <td>${list.email}</td>
                  <td>${list.phone}</td>
                  <td>
                    <button class='btn btn-primary save_btn'>儲存</button>
                    <button class='btn btn-warning cancel_btn'>取消</button>
                  </td>
                </tr>`
            )
          }
          sessionStorage.setItem("lists", JSON.stringify(lists));
        })
        .catch(error => {
          console.log(error)
          Swal.fire({
            icon: "error",
            title: "Oops...",
            text: "出了點狀況！請聯絡管理員"
          });
        });

      let updateStatusValue = "";
      let updateRoleIdValue = "";
      // for status dropdown
      $(document).on('click', '.drop_status_el', function (e) {
        const selectedUserStatus = $(this).closest('tr').find('ul.drop_status').attr('data-bs-target').slice(1);
        const selectedStatus = $(this).text();
        $(this).closest('td').find('.status_dropdown').text(selectedStatus);
        updateStatusValue = parseInt(e.target.getAttribute('value'));
      });

      // for role dropdown
      $(document).on('click', '.drop_role_el', function (e) {
        const selectedRole = $(this).text();
        $(this).closest('td').find('.role_dropdown').text(selectedRole);
        updateRoleIdValue = parseInt(e.target.getAttribute('value'));
      });

      $('.user_lists').on('click', '.save_btn', function () {

        let userList = JSON.parse(sessionStorage.getItem('lists'));
        let targetUserId = parseInt($(this).closest('tr').find('.userId').attr('data-bs-target').slice(1));

        let userToUpdate = {};
        for (let i = 0; i < userList.length; i++) {
          if (userList[i].userId === targetUserId) {
            userToUpdate = userList[i]; // 找到要修改的員工
            break;
          }
        };

        if (userToUpdate) {
          let setStatus = "";
          let setRoleId = "";

          if (userToUpdate.status === "未啟用") {
            userToUpdate.status = "0";
          } else {
            if (userToUpdate.status === "已啟用") {
              userToUpdate.status = "1";
            } else {
              userToUpdate.status = "2";
            }
          };

          if (updateStatusValue === "") {
            setStatus = parseInt(userToUpdate.status);
          } else {
            setStatus = updateStatusValue;
          };

          if (updateRoleIdValue === "") {
            setRoleId = parseInt(userToUpdate.role.roleId);
          } else {
            setRoleId = updateRoleIdValue;
          };

          const userSREdit = {
            userId: targetUserId,
            name: userToUpdate.name,
            email: userToUpdate.email,
            phone: userToUpdate.phone,
            status: setStatus,
            roleId: setRoleId
          };

          fetch('/NGFW/user/manage', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(userSREdit)
          })
            .then(resp => {
              return resp.json();
            })
            .then(data => {
              if (data.successfully) {
                Swal.fire({
                  icon: "success",
                  title: "更新成功",
                  text: ""
                });
              } else {
                Swal.fire({
                  icon: "error",
                  title: "Oh shit..",
                  text: "請與管理員聯絡"
                });

              }
              // 更新sessionStorage
              let updatedUserList = JSON.parse(sessionStorage.getItem('lists'));

              for (let i = 0; i < updatedUserList.length; i++) {
                if (updatedUserList[i].userId === data.userId) {
                  updatedUserList[i] = {
                    userId: data.userId,
                    userAccount: updatedUserList[i].account,
                    name: updatedUserList[i].name,
                    email: updatedUserList[i].email,
                    phone: updatedUserList[i].phone,
                    status: data.status,
                    roleId: data.roleId,
                    role: data.role,
                    sucessfully: data.successfully
                  }
                  break;
                }
              };
              sessionStorage.setItem('lists', JSON.stringify(updatedUserList));
            })
            .catch(error => {
              alert('更新失敗: ' + error.message);
              Swal.fire({
                icon: "error",
                title: "Oops..",
                text: "請與管理員聯絡"
              });
            });
        } else {
          Swal.fire({
            icon: "error",
            title: "Oh no..",
            text: "請聯絡管理員"
          });
        }

      });
    });


    $(document).on("click", "button.list_save_btn", function (e) {
      e.preventDefault();
      e.stopPropagation();
      let userListId = $(this).closest('tr').find('td.userId').text().trim();
    });
  </script>
</body>

</html>