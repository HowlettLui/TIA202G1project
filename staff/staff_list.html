<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>上班不要看球賽管理系統</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel='stylesheet'
    href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback'>
  <!-- Font Awesome -->
  <link rel='stylesheet' href='../vendors/fontawesome-free/css/all.min.css'>
  <!-- overlayScrollbars -->
  <link rel='stylesheet' href='../css/adminlte/OverlayScrollbars.min.css'>
  <!-- Theme style -->
  <link rel='stylesheet' href='../css/adminlte/adminlte.min.css'>
  <!-- Bootstrap 5 -->
  <link rel='stylesheet' href='../css/bootstrap.min.css'>

  <style>
    input[disabled] {
      background: #efefef !important;
      cursor: not-allowed;
    }

    div.left_block {
      /* border: 1px solid green; */
      flex-basis: 150px;
      flex-shrink: 0;
    }

    div.right_block {
      /* border: 1px solid red; */
      flex-grow: 1;
    }

    #preview {
      border: 1px dashed black;
      display: inline-block;
      width: 100%;
      height: 120px;
      position: relative;
      cursor: pointer;
      text-align: center;
    }

    #preview span.text {
      position: absolute;
      display: inline-block;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: -1;
      color: white;
    }

    #preview img.preview_img {
      max-width: 100%;
      max-height: 100%;
      position: relative;
      z-index: -1;
    }

    #preview.-on {
      box-shadow: 5px 5px 15px white inset, -5px -5px 15px white inset;
    }
  </style>
</head>

<body class='hold-transition sidebar-mini'>

  <!-- Site wrapper -->
  <div class='wrapper'>

    <!-- 導入共用 Navbar -->
    <div class='Navbar'></div>
    <!-- 導入共用 Sidebar -->
    <div class='Sidebar'></div>

    <!-- 開發畫面區塊start -->
    <section class='content-wrapper'>

      <!-- content-header，包括頁面名稱、麵包屑 -->
      <section class='content-header'>
        <div>
          <nav aria-label='breadcrumb'>
        </div>
        <ol class='breadcrumb breadcrumb-chevron p-3 bg-body-tertiary rounded-3'>
          <li class='breadcrumb-item'>
            <a class='link-body-emphasis fw-semibold text-decoration-none fs-3' href='#'>使用者資料管理</a>
          </li>
          <li class='breadcrumb-item active fs-3' aria-current='page'>
            工作人員角色管理
          </li>
        </ol>
        </nav>
      </section>
      <!-- content-header end -->

      <!-- content，實際頁面內容 -->
      <section class='content'>
        <div class='card'>
          <!-- card-header -->
          <div class='card-header'>
            <!-- <div class='input-group'>
              <div class='input-group-prepend'>
                <button type='button' class='btn btn-default dropdown-toggle keyword_dropdwn_btn'
                  data-toggle='dropdown'>
                  關鍵字
                </button>
                <div class='dropdown-menu'>
                  <a class='dropdown-item staff_id' href='#'>工作人員編號</a>
                  <a class='dropdown-item staff_name' href='#'>工作人員姓名</a>
                  <a class='dropdown-item staff_phone' href='#'>工作人員電話</a>
                  <div class='dropdown-divider'></div>
                  <a class='dropdown-item' href='#'>Separated link</a>
                </div>
              </div>
              /btn-group
              <div class='p-3'>
                <input type='text' class='form-control form-control-lg fa-align-center'>
              </div>
              Split button
              <div class='p-3'>
                <div class='btn-group'>
                  <button type='button' class='btn btn-success staff_dept_btn'>部門</button>
                  <button type='button' class='btn btn-success dropdown-toggle staff_dept_dropdwn_btn'
                    data-toggle='dropdown'>
                    <span class='sr-only'>Toggle Dropdown</span>
                  </button>
                  <div class='dropdown-menu staff_status_type' role='menu'>
                    <a class='dropdown-item admin' href='#'>管理員</a>
                    <a class='dropdown-item store' href='#'>商城</a>
                    <a class='dropdown-item cs' href='#'>客服</a>
                    <a class='dropdown-item article_reviewer' href='#'>審稿</a>
                    <a class='dropdown-item' href='#'>Separated link</a>
                  </div>
                </div>
                <div class='btn-group'>
                  <button type='button' class='btn btn-warning staff_status_btn'>狀態</button>
                  <button type='button' class='btn btn-warning dropdown-toggle dropdown-icon staff_status_dropdwn_btn'
                    data-toggle='dropdown'>
                    <span class='sr-only'>Toggle Dropdown</span>
                  </button>
                  <div class='dropdown-menu staff_status' role='menu'>
                    <a class='dropdown-item inactivated' href='#'>未啟用</a>
                    <a class='dropdown-item activated' href='#'>已啟用</a>
                    <a class='dropdown-item grounding' href='#'>停用</a>
                    <div class='dropdown-divider'></div>
                    <a class='dropdown-item' href='#'>Separated link</a>
                  </div>
                </div>
              </div>
              <div class='p-3'>
                <div class='btn-group'>
                  <button type='button' class='btn btn-info order_export_btn'>匯出</button>
                  <button type='button' class='btn btn-info dropdown-toggle dropdown-icon order_export_dropdwn_btn'
                    data-toggle='dropdown'>
                    <span class='sr-only'>Toggle Dropdown</span>
                  </button>
                  <div class='dropdown-menu export_type' role='menu'>
                    <a class='dropdown-item for_excel' href='#'>.xml</a>
                    <a class='dropdown-item for_pdf' href='#'>.pdf</a>
                  </div>
                </div>
              </div>
            </div> -->
          </div>
          <!-- /.card-header -->
          <!-- card-body -->
          <div class='card-body'>
            <table id='staff_info' class='table table-bordered table-striped staff_info'>
              <thead>
                <tr>
                  <th><input type='checkbox' class='check_all'></th>
                  <th class='staff_id'>工作人員編號</th>
                  <th class='staff_name'>工作人員姓名</th>
                  <th class='staff_status'>狀態</th>
                  <th class='staff_role'>部門</th>
                  <!-- 用staff_role選擇節點，此節點判斷為某部門時加上專員或經理等職稱，後續加上職稱層級 -->
                  <!-- <th class='staff_role'>職稱</th> -->
                  <th class='staff_email'>工作人員email</th>
                  <th class='staff_phone'>工作人員電話</th>
                  <th class='spacing_block'></th>
                </tr>
              </thead>
              <tbody class="staff_lists">
              </tbody>
            </table>
          </div>
          <!-- /.card-body -->
        </div>
      </section>
      <!-- content end -->

    </section>
    <!-- 開發畫面區塊end -->

  </div>
  <!-- wrapper end -->

  <!-- jQuery -->
  <script src='../jquery/adminlte/jquery.min.js'></script>
  <!-- Bootstrap 5 -->
  <script src='../js/bootstrap.bundle.min.js'></script>
  <!-- overlayScrollbars -->
  <script src='../jquery/adminlte/jquery.overlayScrollbars.min.js'></script>
  <!-- AdminLTE App -->
  <script src='../js/adminlte/adminlte.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    $('.Navbar').load('../layout/navbar.html');
    $('.Sidebar').load('../layout/sidebar.html');

    $(function () {
      fetch("/NGFW/staff/staff_list")
        .then(response => response.json())
        .then(staff_list => {
          for (let list of staff_list) {
            if (list.staffStatus === 0) {
              list.staffStatus = "未啟用";
            } else {
              if (list.staffStatus === 1) {
                list.staffStatus = "已啟用";
              } else {
                list.staffStatus = "停用";
              }
            }

            if (list.staffRole.roleId === 1) {
              list.staffRole.roleType = "管理員";
            } else {
              if (list.staffRole.roleId === 2) {
                list.staffRole.roleType = "客服";
              } else {
                if (list.staffRole.roleId === 3) {
                  list.staffRole.roleType = "商城";
                } else if (list.staffRole.roleId === 5) {
                  list.staffRole.roleType = "審稿";
                } else {
                  list.staffRole.roleType = "未啟用工作者"
                };
              }
            }

            $(".staff_lists").append(
              `<tr>
                  <td><input type='checkbox' class='check_el'></td>
                  <td class="staffId" data-bs-target=#${list.staffId}>${list.staffId}</td>
                  <td>${list.staffName}</td>
                  <td>
                    <button class="btn btn-secondary dropdown-toggle status_dropdown" href="#" role="button" id="dropdownMenuLink" type="button"
                      data-bs-toggle="dropdown" aria-expanded="false">
                      ${list.staffStatus}
                    </button>
                    <ul class="dropdown-menu drop_status" data-bs-target=#${list.staffStatus} aria-labelledby="dropdownMenuLink">
                      <li><a class="dropdown-item drop_status_el inactivated" value="0">未啟用</a></li>
                      <li><a class="dropdown-item drop_status_el activated" value="1">已啟用</a></li>
                      <li><a class="dropdown-item drop_status_el grounding" value="2">停用</a></li>
                    </ul>
                  </td>
                  <td>
                    <button class="btn btn-secondary dropdown-toggle role_dropdown" href="#" role="button" id="dropdownMenuLink"
                      data-bs-toggle="dropdown" aria-expanded="false">
                      ${list.staffRole.roleType}
                    </button>
                    <ul class="dropdown-menu drop_role" data-bs-target=#${list.staffRoleId} aria-labelledby="dropdownMenuLink">
                      <li><a class="dropdown-item drop_role_el admin" value="1">管理員</a></li>
                      <li><a class="dropdown-item drop_role_el cs" value="2">客服</a></li>
                      <li><a class="dropdown-item drop_role_el store" value="3">商城</a></li>
                      <li><a class="dropdown-item drop_role_el article_reviewer" value="5">審稿</a></li>
                    </ul>
                  </td>
                  <td>${list.staffEmail}</td>
                  <td>${list.staffPhone}</td>
                  <td>
                    <button class='btn btn-primary save_btn'>儲存</button>
                    <button class='btn btn-warning cancel_btn'>取消</button>
                    <button class='btn btn-info detail_btn'>詳情</button>
                  </td>
                </tr>`
            )
          }
          sessionStorage.setItem("staff_list", JSON.stringify(staff_list));
        })
        .catch(error => {
          console.log(error)
          Swal.fire({
            icon: "error",
            title: "Oops...",
            text: "出了點狀況！請聯絡管理員"
          });
        });

      let updateStatusValue = "";
      let updateRoleIdValue = "";
      // for status dropdown
      $(document).on('click', '.drop_status_el', function (e) {
        // const selectedStaffId = $(this).closest('tr').find('td.staffId').attr("data-bs-target").slice(1); // 可找到staffId
        // const selectedStaffRoleId = $(this).closest('tr').find('ul.drop_role').attr('data-bs-target').slice(1); // 可找到staffRoleId
        const selectedStaffSatus = $(this).closest('tr').find('ul.drop_status').attr('data-bs-target').slice(1); // 可找到staffStatus
        // console.log("選中的狀態編號：", selectedStaffSatus);  // 初始staffStatus
        const selectedStatus = $(this).text();
        $(this).closest('td').find('.status_dropdown').text(selectedStatus);
        updateStatusValue = parseInt(e.target.getAttribute('value'));
        // console.log("選中的狀態值：", statusValue); // 更改後staffStatus
      });

      // for role dropdown
      $(document).on('click', '.drop_role_el', function (e) {
        const selectedRole = $(this).text();
        $(this).closest('td').find('.role_dropdown').text(selectedRole);
        updateRoleIdValue = parseInt(e.target.getAttribute('value'));
        // console.log("選中的角色值：", roleValue); // staffRoleId
      });
      // ====================================以上在檢查status & roleId==========================================


      $('.staff_lists').on('click', '.save_btn', function () {

        let staffList = JSON.parse(sessionStorage.getItem('staff_list'));
        let targetStaffId = parseInt($(this).closest('tr').find('.staffId').attr('data-bs-target').slice(1));

        let staffToUpdate = {};
        for (let i = 0; i < staffList.length; i++) {
          // console.log('staffList[i].staffId:', staffList[i].staffId);
          // console.log('typeOfStaffList[i].staffId:', typeof staffList[i].staffId);
          if (staffList[i].staffId === targetStaffId) {
            staffToUpdate = staffList[i]; // 找到要修改的員工
            // console.log('staffList[i]:', staffList[i]);
            break;
          }
        };
        // console.log('staffToUpdate:', staffToUpdate); // staff JSON物件

        if (staffToUpdate) {
          // console.log("選中的狀態值：", updateStatusValue); // 更改後staffStatus
          // console.log("選中的角色值：", updateRoleIdValue); // staffRoleId
          // console.log('updateStatus:', updateStatus);
          // console.log('typeof updateStatus:', typeof updateStatus);
          let setStatus = "";
          let setRoleId = "";

          if (staffToUpdate.staffStatus === "未啟用") {
            staffToUpdate.staffStatus = "0";
          } else {
            if (staffToUpdate.staffStatus === "已啟用") {
              staffToUpdate.staffStatus = "1";
            } else {
              staffToUpdate.staffStatus = "2";
            }
          };

          if (updateStatusValue === "") {
            setStatus = parseInt(staffToUpdate.staffStatus);
          } else {
            setStatus = updateStatusValue;
          };

          if (updateRoleIdValue === "") {
            setRoleId = parseInt(staffToUpdate.staffRole.roleId);
          } else {
            setRoleId = updateRoleIdValue;
          };

          const staffSREdit = {
            staffId: targetStaffId,
            // staffAccount: staffToUpdate.staffAccount,
            staffName: staffToUpdate.staffName,
            staffEmail: staffToUpdate.staffEmail,
            staffPhone: staffToUpdate.staffPhone,
            staffStatus: setStatus,
            staffRoleId: setRoleId
          };
          // console.log('staffSREdit:', staffSREdit);

          fetch('/NGFW/staff/manage', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(staffSREdit)
          })
            .then(resp => {
              return resp.json();
            })
            .then(data => {
              if (data.successfully) {
                Swal.fire({
                  icon: "success",
                  title: "更新成功",
                  text: ""
                });
              } else {
                Swal.fire({
                  icon: "error",
                  title: "Oh no..",
                  text: "請與管理員聯絡"
                });

              }

              // 更新sessionStorage中的user_list
              let staffList = JSON.parse(sessionStorage.getItem('staff_list'));

              for (let i = 0; i < staffList.length; i++) {
                // console.log('staffList[i].staffId:', staffList[i].staffId);
                // console.log('typeOfStaffList[i].staffId:', typeof staffList[i].staffId);
                if (staffList[i].staffId === data.staffId) {
                  // staffToUpdate = staffList[i]; // 找到要修改的員工
                  staffList[i] = {
                    staffId: data.staffId,
                    staffAccount: staffList[i].staffAccount,
                    staffName: staffList[i].staffName,
                    staffEmail: staffList[i].staffEmail,
                    staffPhone: staffList[i].staffPhone,
                    staffStatus: data.staffStatus,
                    staffRoleId: data.staffRoleId,
                    staffRole: data.staffRole,
                    staffSucessfully: data.successfully
                  }
                  // console.log('staffList[i]:', staffList[i]);
                  break;
                }
              };
              sessionStorage.setItem('staff_list', JSON.stringify(staffList));
            })
            .catch(error => {
              alert('更新失敗: ' + error.message);
              Swal.fire({
                icon: "error",
                title: "Oops..",
                text: "請與管理員聯絡"
              });
            });
        } else {
          Swal.fire({
            icon: "error",
            title: "Oh no..",
            text: "請聯絡管理員"
          });
        }

      });
    });

    $(document).on("click", "button.detail_btn", function (e) {
      fetch(`/NGFW/staff/staff_list/${$(this).closest('tr').find('td.staffId').attr("data-bs-target").slice(1)}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        },
      })
        .then(response => response.json())
        .then(staff => {
          if (staff.successfully) {
            sessionStorage.setItem("staff", JSON.stringify(staff));

            console.log(staff);

            window.location.href = '/NGFW/staff/staff_manage.html';
          } else {
            alert('選取失敗:', staff.message);
          }
        })
        .catch(error => {
          alert('發生錯誤:', error);
        });
    });

  </script>
</body>

</html>