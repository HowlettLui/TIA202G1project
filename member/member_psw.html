<div class="container">
    <div class="row g-5 p-3">
        <div class="col-md-7 col-lg-11">
            <h4 class="mb-3">修改密碼</h4>
            <form class="needs-validation" novalidate>
                <div class="row g-3">
                    <div class="col-12">
                        <label for="oldPassword" class="form-label">舊密碼</label>
                        <input type="password" class="form-control" id="oldPassword" placeholder="請輸入舊密碼" value=""
                            required>
                        <div class="invalid-feedback">
                            Please enter your old password.
                        </div>
                    </div>
                    <div class="col-12">
                        <label for="newPassword" class="form-label">新密碼</label>
                        <input type="password" class="form-control" id="newPassword" placeholder="請輸入新密碼" required>
                        <div class="invalid-feedback">
                            Please enter your new password.
                        </div>
                    </div>
                    <div class="col-12">
                        <label for="confirmPassword" class="form-label">確認密碼</label>
                        <input type="password" class="form-control" id="confirmPassword" placeholder="請再次輸入新密碼"
                            required>
                        <div class="invalid-feedback">
                            Please enter your new password again.
                        </div>
                    </div>
                    <div class="col-12">
                        <label for="captchaInput">驗證碼(點圖片可更新)</label>
                        <input type="text" class="form-control" id="captchaInput" placeholder="請輸入驗證碼" required>
                        <br>
                        <canvas id="captchaCanvas" width="150" height="50"></canvas>
                        <!-- <button id="checkCaptcha">驗證</button> -->

                        <div id="result"></div>

                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" id="cancelBtn" class="btn btn-secondary me-2">取消</button>
                        <button type="button" id="saveBtn" class="btn btn-primary">確認</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        let captchaText = '';

        function generateCaptcha() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            captchaText = code.toUpperCase(); // 驗證碼轉為大寫

            let canvas = document.getElementById('captchaCanvas');
            let ctx = canvas.getContext('2d');

            // 清除畫布
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 設定背景
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 設定字體樣式
            ctx.font = '30px Arial';
            ctx.fillStyle = '#333';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            // 繪製驗證碼
            ctx.fillText(captchaText, canvas.width / 2, canvas.height / 2);

            // 添加干擾線條
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(Math.random() * canvas.width, Math.random() * canvas.height);
                ctx.lineTo(Math.random() * canvas.width, Math.random() * canvas.height);
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }

        // 初始化驗證碼
        generateCaptcha();

        // 點擊重新生成
        $('#captchaCanvas').click(function (e) {
            generateCaptcha();
            e.preventDefault();
        });



        // 驗證輸入
        // TODO: 之後要換驗證時機點
        $('#saveBtn').click(function (e) {
            const oldPassword = $('#oldPassword').val();
            const newPassword = $('#newPassword').val();
            const confirmPassword = $('#confirmPassword').val();
            const captchaInput = $('#captchaInput').val();

            // TODO: 舊密碼不正確，串候補加上
            console.log("captchaInput= "+ captchaInput.toUpperCase() + ", captchaText= " + captchaText)

            // 新密碼與確認密碼不符
            if (newPassword != confirmPassword) {
                $('#result').text('驗證失敗 ❌，新密碼與驗證密不符，請再試一次').css('color', 'red');
                generateCaptcha();
            }

            // 新密碼長度須介於6~12字元
            if (newPassword.length < 6 || newPassword.length > 12) {
                $('#result').text('驗證失敗 ❌，新密碼長度須介於6~12字元，請再試一次').css('color', 'red');
                generateCaptcha();
            }

            // 驗證碼輸入錯誤
            if (captchaInput.toUpperCase() != captchaText) {
                $('#result').text('驗證失敗 ❌，請再試一次').css('color', 'red');
                generateCaptcha();
            }
            // if (captchaInput.toUpperCase() === captchaText) {
            //     $('#result').text('驗證成功 ✅').css('color', 'green');
            //     // e.preventDefault();
            // } else {
            //     $('#result').text('驗證失敗 ❌，請再試一次').css('color', 'red');
            //     generateCaptcha();
            //     // e.preventDefault();
            // }

        });

    });

</script>