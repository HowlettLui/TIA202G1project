<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>上班不要看球賽管理系統</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="./vendors/fontawesome-free/css/all.min.css">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="./css/adminlte/OverlayScrollbars.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="./css/adminlte/adminlte.min.css">
  <!-- Bootstrap 5 -->
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <!-- dropzonejs -->
  <!-- <link rel="stylesheet" href="./vendors/dropzone/min/dropzone.min.css"> -->

  <!-- for ethan's part -->
  <!-- summernote -->
  <link rel="stylesheet" href="./vendors/summernote-0.9.0-dist/summernote-bs5.min.css">
  <!-- filepond -->
  <link href="https://unpkg.com/filepond@^4/dist/filepond.css" rel="stylesheet" />
  <link href="https://unpkg.com/filepond/dist/filepond.css" rel="stylesheet" />
  <link href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.css"
    rel="stylesheet" />
  <link href="https://unpkg.com/filepond-plugin-image-edit/dist/filepond-plugin-image-edit.css" rel="stylesheet" />

</head>

<body class="hold-transition sidebar-mini">

  <!-- Site wrapper -->
  <div class="wrapper">

    <!-- 導入共用 Navbar -->
    <div class="Navbar"></div>
    <!-- 導入共用 Sidebar -->
    <div class="Sidebar"></div>

    <!-- 開發畫面區塊start -->
    <section id="mainBlock" class="content-wrapper">
      <!-- content-header -->
      <section class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1>編輯商品</h1>
            </div>
            <div class="col-sm-6">
              <ol class="breadcrumb float-sm-right">
                <li class="breadcrumb-item"><a href="#">商品管理</a></li>
                <li class="breadcrumb-item active">編輯商品</li>
              </ol>
            </div>
          </div>
        </div>
      </section>
      <!-- content-header end -->

      <!-- content，實際頁面內容 -->
      <section class="content">
        <div class="card">
          <div class="card-body">
            <div class="row">

              <!-- photos upload with filepond -->
              <!-- <input type="file" class="filepond" name="filepond" accept="image/png, image/jpeg, image/gif"> -->
              <!-- <input type="file" class="filepond" name="filepond" multiple data-max-file-size="3MB" data-max-files="10"
            accept="image/png, image/jpeg, image/gif"> -->
              <!-- photos upload with filepond end -->
              <!-- photos upload with input -->
              <div class="col-12">
                <label for="item_photo">商品照片</label>
                <button id="save_item_photo" class="btn btn-sm btn-light mb-2" type="submit">照片上傳</button>
                <input id="item_photo" name="item_photo" type="file" class="form-control mb-3" multiple>
              </div>
              <!-- photos upload with input end -->

              <div class="col-sm-6">
                <!-- text input -->
                <div class="form-group">
                  <label for="item_model">商品型號</label>
                  <input id="item_model" name="item_model" type="text" class="form-control item_related"
                    placeholder="Enter ...">
                  <div class="invalid-feedback">請輸入型號！</div>
                </div>
              </div>
              <div class="col-sm-6">
                <!-- text input -->
                <div class="form-group">
                  <label for="item_name">商品名稱</label>
                  <input id="item_name" name="item_name" type="text" class="form-control item_related"
                    placeholder="Enter ...">
                  <div class="invalid-feedback">請輸入名稱！</div>
                </div>
              </div>
              <div class="col-sm-6">
                <!-- text input -->
                <div class="form-group">
                  <label for="item_color">商品顏色</label>
                  <input id="item_color" name="item_color" type="text" class="form-control item_related"
                    placeholder="Enter ...">
                  <div class="invalid-feedback">請輸入顏色！</div>
                </div>
              </div>
              <div class="col-sm-6">
                <!-- text input -->
                <div class="form-group">
                  <label for="item_size">商品大小</label>
                  <input id="item_size" name="item_size" type="text" class="form-control item_related"
                    placeholder="Enter ...">
                  <div class="invalid-feedback">請輸入大小！</div>
                </div>
              </div>
              <div class="col-sm-6">
                <!-- text input -->
                <div class="form-group">
                  <label for="item_type">商品類型</label>
                  <input id="item_type" name="item_type" type="text" class="form-control item_related"
                    placeholder="Enter ...">
                  <div class="invalid-feedback">請輸入類型！</div>
                </div>
              </div>
              <div class="col-sm-6">
                <!-- text input -->
                <div class="form-group">
                  <label for="item_content">商品簡介</label>
                  <input id="item_content" name="item_content" type="text" class="form-control item_related"
                    placeholder="Enter ...">
                  <div class="invalid-feedback">請輸入簡介！</div>
                </div>
              </div>
              <div class="col-sm-6">
                <!-- text input -->
                <div class="form-group">
                  <label for="item_price">商品價格</label>
                  <input id="item_price" name="item_price" type="text" class="form-control should_be_a_number"
                    placeholder="Enter ...">
                  <div class="invalid-feedback">請輸入價格！</div>
                </div>
              </div>
              <div class="col-sm-6">
                <!-- text input -->
                <div class="form-group">
                  <label for="item_stock">商品數量</label>
                  <input id="item_stock" name="item_stock" type="text" class="form-control should_be_a_number"
                    placeholder="Enter ...">
                  <div class="invalid-feedback">請輸入數量！</div>
                </div>
              </div>

              <!-- summernote -->
              <div class="col-12">
                <label for="summernote">商品詳細內容</label>
                <div id="summernote">請輸入商品詳細內容</div>
              </div>

            </div>
            <div class="mt-4">
              <button id="save_item" class="btn btn-success" type="submit">儲存商品</button>
              <button id="publish_item" class="btn btn-primary" type="submit">商品上架</button>
              <button id="cancle" class="btn btn-warning" type="submit">取消</button>
            </div>
          </div>
          <!-- card-body end -->
        </div>
        <!-- card end -->
      </section>
      <!-- content end -->
    </section>
    <!-- 開發畫面區塊end -->

  </div>
  <!-- wrapper end -->

  <!-- jQuery -->
  <script src="./jquery/adminlte/jquery.min.js"></script>
  <!-- Bootstrap 5 -->
  <script src="./js/bootstrap.bundle.min.js"></script>
  <!-- overlayScrollbars -->
  <script src="./jquery/adminlte/jquery.overlayScrollbars.min.js"></script>
  <!-- AdminLTE App -->
  <script src="./js/adminlte/adminlte.min.js"></script>
  <!-- dropzonejs -->
  <!-- <script src="./vendors/dropzone/min/dropzone.min.js"></script> -->

  <!-- for ethan's part -->
  <!-- summernote -->
  <script src="./vendors/summernote-0.9.0-dist/summernote-bs5.js"></script>
  <!-- sweetalert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- filepond -->
  <!-- <script src="https://unpkg.com/filepond@^4/dist/filepond.js"></script> -->
  <!-- <script
src="https://unpkg.com/filepond-plugin-file-validate-type/dist/filepond-plugin-file-validate-type.js"></script>
<script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.js"></script> -->
  <!-- <script src="https://unpkg.com/filepond-plugin-image-edit/dist/filepond-plugin-image-edit.js"></script> -->

  <script>
    $(function () {
      // Summernote
      $('#summernote').summernote()
    })

    $(".Navbar").load("./layout/navbar.html");
    $(".Sidebar").load("./layout/sidebar.html");

    $(document).on('blur', 'input.item_related', function () {
      validateFields($(this));
    })

    $(document).on('blur', 'input.should_be_a_number', function () {
      validateFields($(this), true);
    })

    let itemPhotosPath;

    $('#save_item').on('click', function () {
      let isValid = validateFields($('input.item_related'));
      let numValid = validateFields($('input.should_be_a_number'), true);
      let summernoteValid = ($('#summernote').summernote('code') !== "請輸入商品詳細內容") && ($('#summernote').summernote('code').trim() !== "");

      if (!isValid || !numValid) {
        Swal.fire({
          icon: "warning",
          title: "請再確認",
          text: "請輸入完整資料！"
        });
      } else if (itemPhotosPath === "") {
        Swal.fire({
          icon: "warning",
          title: "請再確認",
          text: "請先點選照片上傳按鈕"
        });
      } else if (!summernoteValid) {
        Swal.fire({
          icon: "warning",
          title: "請再確認",
          text: "請輸入商品詳細內容！"
        });
      } else {
        const itemModel = {
          itemModel: $('#item_model').val(),
          // staffId: ???
        }
        const item = {
          itemName: $('#item_name').val(),
          itemContent: $('#item_content').val(),
          itemType: $('#item_type').val(),
          itemPrice: $('#item_price').val(),
          itemDetails: $('#summernote').summernote('code'),
          itemPhoto: itemPhotosPath.toString(),
          // staffId: ???
        }
        const itemInfo = {
          itemSize: $('#item_size').val(),
          itemColor: $('#item_color').val(),
          itemStock: $('#item_stock').val(),
          // staffId: ???
        }

        fetch('estoreadmin/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            itemModel,
            item,
            itemInfo
          })
        })
          .then(resp => resp.json())
          .then(data => {
            if (data.result) {
              Swal.fire({
                icon: "success",
                title: "新增成功",
                text: data.message,
              });
            } else {
              Swal.fire({
                icon: "error",
                title: "新增失敗",
                text: data.message,
              });
            }
          })
          .catch((error) => {
            console.error('Error:', error);
            Swal.fire({
              icon: "error",
              title: "Oops...",
              text: "出了點狀況！請聯絡管理員"
            });
          });
      }
    });

    function validateFields(items, checkNumber = false) {
      let allValid = true;
      items.each(function () {
        let value = $(this).val().trim();
        let isValid = value !== "";

        if (checkNumber) {
          isValid = isValid && !isNaN(value);
        }

        if (isValid) {
          $(this).addClass("is-valid").removeClass("is-invalid");
        } else {
          $(this).addClass("is-invalid").removeClass("is-valid");
          allValid = false;
        }
      });
      return allValid;
    }

    $('#save_item_photo').on('click', function () {

      const formData = new FormData();
      const input = document.querySelector('#item_photo');

      for (let file of input.files) {
        formData.append('item_photo', file, file.name);
      }

      fetch('estoreadmin/upload', {
        method: 'POST',
        body: formData,
      })
        .then(resp => resp.json())
        .then(data => {
          itemPhotosPath = JSON.stringify(data);
          Swal.fire({
            icon: "success",
            title: "新增成功",
            text: "新增商品照片成功！",
          });
        })
        .catch((error) => {
          console.error('Error:', error);
          Swal.fire({
            icon: "error",
            title: "Oops...",
            text: "圖片上傳失誤，請重新上傳或者聯絡管理員"
          });
        });

    });

  </script>

  <script>

    // 動態載入內容
    // $(document).ready(function () {
    //     // 使用事件代理確保所有 <a> 都正確綁定事件
    //     $('li.item_management').on('click', 'a.item_management', function (event) {
    //       event.stopPropagation(); // 阻止事件冒泡
    //       event.preventDefault(); // 阻止預設行為
    //       const url = $(this).attr('href'); // 取得 href 的值
    //       $('#mainBlock').load(url, function (response, status, xhr) {
    //           if (status === "error") {
    //               $('#mainBlock').html("<h1>錯誤</h1><p>無法載入頁面內容。</p>");
    //           }
    //       });
    //     });
    // });

    // filepond
    // const filepondPlugins = FilePond.registerPlugin(
    //   FilePondPluginImagePreview,
    //   FilePondPluginFileValidateType,
    //   // FilePondPluginImageEdit
    // );

    // // Get a reference to the file input element
    // const inputElement = document.querySelector('input[type="file"]');

    // // Create a FilePond instance
    // const pond = FilePond.create(inputElement,
    //   {
    //     labelIdle: '拖曳或點擊上傳商品照片',
    //     imagePreviewHeight: 200,
    //   }
    // );

    // const filesPaths = [];

    // FilePond.setOptions({
    //   server: {
    //     url: 'http://localhost:8080/NGFW/',
    //     process: {
    //       url: 'estoreadmin/upload',
    //       method: 'POST',
    //       onload: (response) => {
    //         const filesPath = JSON.parse(response);
    //         console.log(filesPath);
    //         // filesPaths.add(JSON.parse(response));
    //       },
    //       onerror: (response) => response.data,
    //     },
    //     revert: null,
    //     restore: null,
    //     load: null,
    //   }
    // });
  </script>
</body>

</html>